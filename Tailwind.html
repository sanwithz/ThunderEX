<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>THUNDER ‚ö° EXPRESS</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
    <!-- Sweet Alert -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Prompt', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #6C4CFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        #map {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            height: 280px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn {
            transition: all 0.2s ease;
            transform: translateY(0);
        }
        
        .action-btn:active {
             transform: scale(0.98);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 76, 255, 0.3);
        }
        
        .friend-item {
            transition: all 0.2s ease;
        }
        
        .friend-item:hover {
            transform: translateX(4px);
            background: #f8fafc;
        }
        
        .status-badge {
            animation: pulse 2s infinite;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #6C4CFF 0%, #9333ea 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .friend-marker {
          border: 3px solid #fff;
          border-radius: 50%;
          box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
        </div>
    </div>

    <div class="min-h-full bg-gray-50">
        <!-- HEADER -->
        <div class="gradient-bg px-6 py-8 text-white">
            <div class="max-w-md mx-auto">
                <h1 class="text-2xl font-bold text-center mb-6">
                    THUNDER ‚ö° EXPRESS
                </h1>
                
                <div class="glass-effect rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div id="avatar" class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center bg-cover bg-center">
                            <i class="fas fa-user text-white text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm text-white text-opacity-80 font-medium">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                            <p id="display-name" class="font-semibold">Sanwithz Webapp</p>
                        </div>
                        <div class="status-badge bg-green-400 w-3 h-3 rounded-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="max-w-md mx-auto px-6 -mt-4 pb-8">
            <!-- MAP CARD -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div id="map" class="map-container mb-6">
                    <!-- Leaflet map will render here -->
                </div>
                
                <!-- ACTION BUTTONS -->
                <div class="space-y-3">
                    <button id="btn-share" class="action-btn w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-medium py-4 px-6 rounded-xl shadow-lg flex items-center justify-center space-x-3">
                        <i class="fas fa-rocket text-lg"></i>
                        <span>‡πÅ‡∏ä‡∏£‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
                    </button>
                    
                    <button id="btn-picker" class="action-btn w-full bg-green-500 hover:bg-green-600 text-white font-medium py-4 px-6 rounded-xl shadow-lg flex items-center justify-center space-x-3">
                        <i class="fab fa-line text-lg"></i>
                        <span>‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô LINE</span>
                    </button>
                    
                    <button id="btn-refresh" class="action-btn w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl border border-gray-200 flex items-center justify-center space-x-3" style="display:none">
                        <i class="fas fa-sync-alt text-lg"></i>
                        <span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
                    </button>
                </div>
            </div>

            <!-- FRIENDS SECTION -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                        <span class="text-xl">üß≠</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô</h2>
                    </div>
                </div>
                
                <ul class="friend-list space-y-4">
                    <!-- Friends will be dynamically populated here -->
                </ul>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script>
    const liffId       = "2007533959-l0B390og";
    const WEBAPP_URL   = "https://script.google.com/macros/s/AKfycbw_jCAwxTFErgt9H3aul4_gL4Mq-vIDvGBOOotjWAyOS9LRoodD7X2Z2VRbqIUSPaOp/exec";
    let map, meProfile, myCoords;
    const friendMarkers = [];

    // 1) Initialize LIFF & get profile
    async function initializeLiff() {
      await liff.init({ liffId, withLoginOnExternalBrowser: true });
      if (!liff.isLoggedIn()) return liff.login();
      meProfile = await liff.getProfile();
      $('#avatar').css('background-image', `url(${meProfile.pictureUrl})`).html('');
      $('#display-name').text(meProfile.displayName);
    }

    // 2) Initialize map after geolocation
    function initMap() {
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'' }).addTo(map);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          myCoords = [pos.coords.latitude, pos.coords.longitude];
          map.setView(myCoords, 15);
          L.circleMarker(myCoords, {
            radius:8, fillColor:'#6C4CFF', color:'#fff', weight:3, fillOpacity:1
          }).addTo(map).bindPopup('‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà').openPopup();
          loadFriendsOnMap();
        }, () => {
          map.setView([13.7563,100.5018],13);
          loadFriendsOnMap();
        });
      } else {
        map.setView([13.7563,100.5018],13);
        loadFriendsOnMap();
      }
    }

    // 3) Load all friends from Sheet
    async function loadFriendsOnMap() {
      try {
        $('#loadingOverlay').addClass('active');
        const res     = await fetch(WEBAPP_URL);
        const friends = await res.json();
        $('.friend-list').empty(); // Clear list before adding new items
        friends.forEach(f => appendFriend(f));
      } catch (e) {
        console.error('load failed', e);
        Swal.fire('Error', '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      } finally {
        $('#loadingOverlay').removeClass('active');
      }
    }

    // 4) Append friend to list & map
    function appendFriend({ id, name, pictureUrl, timestamp, lat, lng, placeName }) {
        const $list = $('.friend-list');
        const displayName = placeName || name;
        const $item = $(`
            <li class="friend-item bg-gray-50 rounded-xl p-3 flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-cover bg-center flex-shrink-0" style="background-image:url('${pictureUrl}')"></div>
                <div class="flex-1 min-w-0">
                    <p class="font-semibold text-gray-800 truncate">${displayName}</p>
                    ${placeName ? `<p class="text-xs text-gray-500">‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏î‡∏¢: ${name}</p>` : ''}
                    <p class="text-xs text-gray-500">${new Date(timestamp).toLocaleString('th-TH')}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="navigate-btn w-10 h-10 flex items-center justify-center bg-purple-100 text-purple-600 rounded-full hover:bg-purple-600 hover:text-white transition-colors" title="‡∏ô‡∏≥‡∏ó‡∏≤‡∏á">
                        <i class="fas fa-directions"></i>
                    </button>
                    <button class="delete-btn w-10 h-10 flex items-center justify-center bg-red-100 text-red-600 rounded-full hover:bg-red-600 hover:text-white transition-colors" title="‡∏•‡∏ö">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </li>
        `);
        $list.prepend($item);

        // Navigate
        $item.find('.navigate-btn').click(() => {
            if (!myCoords) return Swal.fire('Error','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì','warning');
            const [myLat, myLng] = myCoords;
            const url = `https://www.google.com/maps/dir/?api=1`
                        + `&origin=${myLat},${myLng}`
                        + `&destination=${lat},${lng}`;
            window.open(url,'_blank');
        });

        // Delete
        $item.find('.delete-btn').click(async () => {
            const result = await Swal.fire({
                title: `‡∏•‡∏ö ${displayName}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
            });
            if (!result.isConfirmed) return;

            try {
                $('#loadingOverlay').addClass('active');
                const res  = await fetch(WEBAPP_URL, {
                    method:'POST',
                    headers:{'Content-Type':'text/plain'},
                    body: JSON.stringify({ action:'delete', id })
                });
                const json = await res.json();
                if (json.status === 'deleted') {
                    $item.remove();
                    const idx = friendMarkers.findIndex(m => m.id === id);
                    if (idx > -1) {
                        map.removeLayer(friendMarkers[idx].marker);
                        friendMarkers.splice(idx,1);
                    }
                    Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', '', 'success');
                } else {
                    Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '', 'info');
                }
            } catch (e) {
                console.error('delete failed', e);
                Swal.fire('Error','‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
            } finally {
                $('#loadingOverlay').removeClass('active');
            }
        });

        // Map marker
        const icon   = L.icon({ iconUrl:pictureUrl, iconSize:[40,40], iconAnchor:[20,20], className:'friend-marker' });
        const marker = L.marker([lat,lng],{icon})
                         .addTo(map)
                         .bindPopup(`<b>${displayName}</b><br>${placeName ? `‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏î‡∏¢: ${name}<br>` : ''}${new Date(timestamp).toLocaleString('th-TH')}`);
        friendMarkers.push({ id, marker });
    }

    // 5) Share & Save
    async function shareAndSave(placeName) {
        if (!meProfile) await initializeLiff();
        if (!myCoords) return Swal.fire('Error','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì','warning');
        const [lat, lng] = myCoords;
        const payload    = { 
            name: meProfile.displayName, 
            pictureUrl: meProfile.pictureUrl, 
            lat, 
            lng, 
            placeName 
        };

        try {
            $('#loadingOverlay').addClass('active');
            const res  = await fetch(WEBAPP_URL, {
                method:'POST',
                headers:{'Content-Type':'text/plain'},
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            if (json.status !== 'success') throw json;
            appendFriend({
                id: json.id,
                name: meProfile.displayName,
                pictureUrl: meProfile.pictureUrl,
                timestamp: new Date(),
                lat, 
                lng,
                placeName
            });
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÅ‡∏ä‡∏£‡πå‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (e) {
            console.error('share failed', e);
            Swal.fire('Error','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
        } finally {
            $('#loadingOverlay').removeClass('active');
        }
    }

    // Prompt for place name
    async function promptForPlaceName() {
        const { value: placeName } = await Swal.fire({
            title: '‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà',
            input: 'text',
            inputLabel: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î',
            inputPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô, ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô, ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡πÇ‡∏õ‡∏£‡∏î',
            showCancelButton: true,
            confirmButtonText: '‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏•‡∏¢!',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            inputValidator: (value) => {
                if (!value) {
                    return '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà!'
                }
            }
        });

        if (placeName) {
            shareAndSave(placeName);
        }
    }

    // 6) Share Flex message
    async function shareTarget() {
        if (!meProfile) await initializeLiff();
        if (!myCoords) return Swal.fire('Error','‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì','warning');
        const [lat, lng] = myCoords;

¬† const flexMessage = {
¬† ¬† type: 'flex',
¬† ¬† altText: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',
¬† ¬† contents: {
¬† ¬† ¬† type: 'bubble',
¬† ¬† ¬† hero: {
¬† ¬† ¬† ¬† type: 'image',
¬† ¬† ¬† ¬† url: meProfile.pictureUrl,
¬† ¬† ¬† ¬† size: 'full',
¬† ¬† ¬† ¬† aspectRatio: '1:1',
¬† ¬† ¬† ¬† aspectMode: 'cover'
¬† ¬† ¬† },
¬† ¬† ¬† body: {
¬† ¬† ¬† ¬† type: 'box',
¬† ¬† ¬† ¬† layout: 'vertical',
¬† ¬† ¬† ¬† contents: [
¬† ¬† ¬† ¬† ¬† { type: 'text', text:`${meProfile.displayName} ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà`, weight:'bold', size:'md', margin:'md' },
¬† ¬† ¬† ¬† ¬† { type: 'text', text:`Latitude: ${lat.toFixed(6)}\nLongitude: ${lng.toFixed(6)}`, wrap:true, margin:'sm' }
¬† ¬† ¬† ¬† ]
¬† ¬† ¬† },
¬† ¬† ¬† footer: {
¬† ¬† ¬† ¬† type: 'box',
¬† ¬† ¬† ¬† layout: 'vertical',
¬† ¬† ¬† ¬† spacing: 'sm',
¬† ¬† ¬† ¬† contents: [
¬† ¬† ¬† ¬† ¬† {
¬† ¬† ¬† ¬† ¬† ¬† type:'button',
¬† ¬† ¬† ¬† ¬† ¬† style:'primary',
¬† ¬† ¬† ¬† ¬† ¬† action:{
¬† ¬† ¬† ¬† ¬† ¬† ¬† type:'uri',
¬† ¬† ¬† ¬† ¬† ¬† ¬† label:'‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ',
¬† ¬† ¬† ¬† ¬† ¬† ¬† // <-- omit origin so Maps uses your device location automatically
¬† ¬† ¬† ¬† ¬† ¬† ¬† uri: `https://www.google.com/maps/dir/?api=1`
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†+ `&destination=${lat},${lng}`
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ]
¬† ¬† ¬† }
¬† ¬† }
¬† };

        if (liff.isInClient() && liff.isApiAvailable('shareTargetPicker')) {
            try { await liff.shareTargetPicker([flexMessage]); return; }
            catch (e) { console.warn(e); }
        }

        window.open(
            `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(
                `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`
            )}`,
            '_blank'
        );
    }

    // 7) DOM Ready
    $(async () => {
        await initializeLiff();
        initMap();
        $('#btn-share').click(promptForPlaceName);
        $('#btn-picker').click(shareTarget);
        $('#btn-refresh').click(initializeLiff);
    });
    </script>
</body>
</html>

