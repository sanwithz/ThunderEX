<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>THUNDER âš¡ EXPRESS</title>

    <!-- jquery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  
    <!-- Tailwind css -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  
  <!-- Loading Overlay -->
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

  <!-- Sweet Alert -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />
  <!-- Font & Icons -->
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Prompt',sans-serif }
    body { background: rgb(252, 233, 233);
      background: linear-gradient(0deg, rgba(252, 233, 233, 1) 0%, rgba(224, 244, 241, 1) 26%, rgba(255, 255, 255, 1) 71%); color:#333}
    .app-container { max-width:100%; margin:0 auto; min-height:100vh; }
    .header { background:linear-gradient(to right,#1BC5F7,#0084FF); padding:20px; border-radius:0 0 20px 20px; text-align:center; color:#fff; }
    .user-status { display:flex; align-items:center; justify-content:center; gap:8px }
    .avatar { width:28px; height:28px; border-radius:50%; background:#fff center/cover no-repeat; display:flex; align-items:center; justify-content:center; color:#FF617E; font-weight:bold }
    .display-name { font-weight:500 }

    .map-card { margin:16px; background:#fff; border-radius:20px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.15) }
    #map { width:100%; height:360px }
    .action-buttons { display:flex; gap:12px; padding:16px }
    .action-btn { flex:1; background:linear-gradient(to right,#1BC5F7,#0084FF); color:#fff; border:none; border-radius:30px; padding:14px; font-size:16px; font-weight:700; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; transition:.2s }
    .action-btn:active { transform:scale(0.98) }

    .section-title { display:flex; align-items:center; gap:6px; padding:0 20px; margin:20px 0 12px; font-size:16px; font-weight:500; color:#444 }
    .friend-list { padding:0 16px }
    .friend-item { display:flex; align-items:center; background:#fff; border-radius:20px; padding:12px 16px; margin-bottom:12px; box-shadow:0 5px 15px rgba(0,0,0,0.15) }
    .friend-avatar { width:50px; height:50px; border-radius:50%; background-size:cover; background-position:center; margin-right:12px }
    .friend-info { flex:1 }
    .friend-name { font-weight:700; font-size:16px; margin-bottom:4px }
    .friend-time { font-size:12px; color:#777 }
    .navigate-btn { background:linear-gradient(to right,#1BC5F7,#0084FF); color:#fff; border:none; border-radius:20px; padding:8px 14px; font-size:14px; font-weight:500; display:flex; align-items:center; gap:6px; cursor:pointer; box-shadow:0 3px 8px rgba(0,132,255,0.25) }

    
.friend-marker {
  border: 3px solid #fff;
  border-radius: 50%;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
    
    .delete-btn {
  /* fallback if not using Tailwind */
  background: #e53e3e;
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 0.375rem;
  margin-left: 0.5rem;
  font-size: 0.875rem;
}
.delete-btn:hover {
  background: #c53030;
}

    
</style>

</head>

<body>
  <div class="app-container">
    <!-- HEADER -->
    <div class="header">
          <h2 class="text-3xl font-semibold text-white-700"> THUNDER âš¡ EXPRESS</h2>
      <div class="user-status mt-4">
        USER : <div class="avatar"></div>
        <span class="display-name">Sanwithz Webapp</span>
      </div>
    </div>

    <!-- MAP & ACTIONS -->
    <div class="map-card">
      <div id="map"></div>
      <div class="action-buttons">
        <button id="btn-share" class="action-btn text-sm">
          <i class="fas fa-rocket"></i>à¹à¸Šà¸£à¹Œà¸à¸´à¸à¸±à¸”à¸‚à¸­à¸‡à¸‰à¸±à¸™
        </button>
        <button class="navigate-btn text-sm">
          <i class="fas fa-map-marker-alt"></i> à¸™à¸³à¸—à¸²à¸‡
        </button>
        <button class="delete-btn text-sm bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded ml-2">
          <i class="fas fa-trash-alt"></i> à¸¥à¸š
        </button>
      </div>
    </div>

Â Â 
Â  <!-- FRIEND LIST -->
<div class="section-title">
Â  <span>ğŸ§­</span>
Â  <span>à¹€à¸à¸·à¹ˆà¸­à¸™à¹ƒà¸à¸¥à¹‰à¸‰à¸±à¸™ à¸¡à¸µà¹ƒà¸„à¸£à¸šà¹‰à¸²à¸‡</span>
</div>
<ul class="friend-list"></ul>

Â  </div>
Â Â 
Â  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

Â  Â  <script>
Â  const liffIdÂ  Â  Â = "2007533959-l0B390og";
Â  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw_jCAwxTFErgt9H3aul4_gL4Mq-vIDvGBOOotjWAyOS9LRoodD7X2Z2VRbqIUSPaOp/exec";
Â  let map, meProfile, myCoords;
Â  const friendMarkers = [];

Â  // 1) Initialize LIFF & get profile
Â  async function initializeLiff() {
Â  Â  await liff.init({ liffId, withLoginOnExternalBrowser: true });
Â  Â  if (!liff.isLoggedIn()) return liff.login();
Â  Â  meProfile = await liff.getProfile();
Â  Â  $('.avatar').css('background-image', `url(${meProfile.pictureUrl})`);
Â  Â  $('.display-name').text(meProfile.displayName);
Â  }

Â  // 2) Initialize map after geolocation
Â  function initMap() {
Â  Â  map = L.map('map');
Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'' }).addTo(map);

Â  Â  if (navigator.geolocation) {
Â  Â  Â  navigator.geolocation.getCurrentPosition(pos => {
Â  Â  Â  Â  myCoords = [pos.coords.latitude, pos.coords.longitude];
Â  Â  Â  Â  map.setView(myCoords, 15);
Â  Â  Â  Â  L.circleMarker(myCoords, {
Â  Â  Â  Â  Â  radius:8, fillColor:'#007AFF', color:'#fff', weight:2, fillOpacity:0.9
Â  Â  Â  Â  }).addTo(map).bindPopup('à¸„à¸¸à¸“à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆà¸™à¸µà¹ˆ').openPopup();
Â  Â  Â  Â  loadFriendsOnMap();
Â  Â  Â  }, () => {
Â  Â  Â  Â  map.setView([13.7563,100.5018],13);
Â  Â  Â  Â  loadFriendsOnMap();
Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  map.setView([13.7563,100.5018],13);
Â  Â  Â  loadFriendsOnMap();
Â  Â  }
Â  }

Â  // 3) Load all friends from Sheet
Â  async function loadFriendsOnMap() {
Â  Â  try {
Â  Â  Â  $.LoadingOverlay("show");
Â  Â  Â  const resÂ  Â  Â = await fetch(WEBAPP_URL);
Â  Â  Â  const friends = await res.json();
Â  Â  Â  friends.forEach(f => appendFriend(f));
Â  Â  } catch (e) {
Â  Â  Â  console.error('load failed', e);
Â  Â  Â  Swal.fire('Error', 'à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ', 'error');
Â  Â  } finally {
Â  Â  Â  $.LoadingOverlay("hide");
Â  Â  }
Â  }

Â  // 4) Append friend to list & map
  // <!-- UPDATED 1: Added 'placeName' to the function parameters -->
Â  function appendFriend({ id, name, pictureUrl, timestamp, lat, lng, placeName }) {
Â  Â  const $list = $('.friend-list');
    // <!-- UPDATED 2: Use the custom placeName if it exists, otherwise use the user's name -->
    const displayName = placeName || name;
Â  Â  const $item = $(`
Â  Â  Â  <div class="friend-item" data-id="${id}">
Â  Â  Â  Â  <div class="friend-avatar" style="background-image:url('${pictureUrl}')"></div>
Â  Â  Â  Â  <div class="friend-info">
          <!-- UPDATED 3: Display the location name and who shared it -->
Â  Â  Â  Â  Â  <div class="friend-name">${displayName}</div>
          ${placeName ? `<div class="text-xs text-gray-500 -mt-1">à¹à¸Šà¸£à¹Œà¹‚à¸”à¸¢: ${name}</div>` : ''}
Â  Â  Â  Â  Â  <div class="friend-time">${new Date(timestamp).toLocaleString('th-TH')}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="navigate-btn text-sm">
Â  Â  Â  Â  Â  <i class="fas fa-map-marker-alt"></i> à¸™à¸³à¸—à¸²à¸‡
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button class="delete-btn text-sm bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded ml-2">
Â  Â  Â  Â  Â  <i class="fas fa-trash-alt"></i> à¸¥à¸š
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  `);
Â  Â  $list.prepend($item);

Â  Â  // Navigate
Â  Â  $item.find('.navigate-btn').click(() => {
Â  Â  Â  if (!myCoords) return Swal.fire('Error','à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“','warning');
Â  Â  Â  const [myLat, myLng] = myCoords;
Â  Â  Â  const url = `https://www.google.com/maps/dir/?api=1`
Â  Â  Â  Â  Â  Â  Â  Â  + `&origin=${myLat},${myLng}`
Â  Â  Â  Â  Â  Â  Â  Â  + `&destination=${lat},${lng}`;
Â  Â  Â  window.open(url,'_blank');
Â  Â  });

Â  Â  // Delete
Â  Â  $item.find('.delete-btn').click(async () => {
Â  Â  Â  const result = await Swal.fire({
        // <!-- UPDATED 4: Show the correct name in the delete confirmation -->
Â  Â  Â  Â  title: `à¸¥à¸š ${displayName}?`,
Â  Â  Â  Â  icon: 'warning',
Â  Â  Â  Â  showCancelButton: true,
Â  Â  Â  Â  confirmButtonText: 'à¹ƒà¸Šà¹ˆ, à¸¥à¸šà¹€à¸¥à¸¢',
Â  Â  Â  Â  cancelButtonText: 'à¸¢à¸à¹€à¸¥à¸´à¸'
Â  Â  Â  });
Â  Â  Â  if (!result.isConfirmed) return;

Â  Â  Â  try {
Â  Â  Â  Â  $.LoadingOverlay("show");
Â  Â  Â  Â  const resÂ  = await fetch(WEBAPP_URL, {
Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  headers:{'Content-Type':'text/plain'},
Â  Â  Â  Â  Â  body: JSON.stringify({ action:'delete', id })
Â  Â  Â  Â  });
Â  Â  Â  Â  const json = await res.json();
Â  Â  Â  Â  if (json.status === 'deleted') {
Â  Â  Â  Â  Â  $item.remove();
Â  Â  Â  Â  Â  const idx = friendMarkers.findIndex(m => m.id === id);
Â  Â  Â  Â  Â  if (idx > -1) {
Â  Â  Â  Â  Â  Â  map.removeLayer(friendMarkers[idx].marker);
Â  Â  Â  Â  Â  Â  friendMarkers.splice(idx,1);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Swal.fire('à¸¥à¸šà¹à¸¥à¹‰à¸§!', '', 'success');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Swal.fire('à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥', '', 'info');
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('delete failed', e);
Â  Â  Â  Â  Swal.fire('Error','à¸¥à¸šà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ','error');
Â  Â  Â  } finally {
Â  Â  Â  Â  $.LoadingOverlay("hide");
Â  Â  Â  }
Â  Â  });

Â  Â  // Map marker
Â  Â  const iconÂ  Â = L.icon({ iconUrl:pictureUrl, iconSize:[40,40], iconAnchor:[20,20], className:'friend-marker' });
Â  Â  const marker = L.marker([lat,lng],{icon})
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .addTo(map)
                    // <!-- UPDATED 5: Update the map pin popup -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .bindPopup(`<b>${displayName}</b><br>${placeName ? `à¹à¸Šà¸£à¹Œà¹‚à¸”à¸¢: ${name}<br>` : ''}${new Date(timestamp).toLocaleString('th-TH')}`);
Â  Â  friendMarkers.push({ id, marker });
Â  }

Â  // 5) Share & Save
  // <!-- UPDATED 6: This function now accepts the 'placeName' from the prompt -->
Â  async function shareAndSave(placeName) {
Â  Â  if (!meProfile) await initializeLiff();
Â  Â  if (!myCoords) return Swal.fire('Error','à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“','warning');
Â  Â  const [lat, lng] = myCoords;
    // <!-- UPDATED 7: Add 'placeName' to the data sent to your backend -->
Â  Â  const payloadÂ  Â  = { 
        name: meProfile.displayName, 
        pictureUrl: meProfile.pictureUrl, 
        lat, 
        lng, 
        placeName 
    };

Â  Â  try {
Â  Â  Â  $.LoadingOverlay("show");
Â  Â  Â  const resÂ  = await fetch(WEBAPP_URL, {
Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  headers:{'Content-Type':'text/plain'},
Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  });
Â  Â  Â  const json = await res.json();
Â  Â  Â  if (json.status !== 'success') throw json;
      // <!-- UPDATED 8: Pass the new 'placeName' to the appendFriend function -->
Â  Â  Â  appendFriend({
Â  Â  Â  Â  id: json.id,
Â  Â  Â  Â  name: meProfile.displayName,
Â  Â  Â  Â  pictureUrl: meProfile.pictureUrl,
Â  Â  Â  Â  timestamp: new Date(),
Â  Â  Â  Â  lat, 
        lng,
        placeName
Â  Â  Â  });
Â  Â  Â  Swal.fire('à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!', 'à¹à¸Šà¸£à¹Œà¸à¸´à¸à¸±à¸”à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢', 'success');
Â  Â  } catch (e) {
Â  Â  Â  console.error('share failed', e);
Â  Â  Â  Swal.fire('Error','à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ','error');
Â  Â  } finally {
Â  Â  Â  $.LoadingOverlay("hide");
Â  Â  }
Â  }

  // <!-- NEW FUNCTION: Prompt the user for a place name -->
  async function promptForPlaceName() {
    const { value: placeName } = await Swal.fire({
        title: 'à¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ',
        input: 'text',
        inputLabel: 'à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸—à¸µà¹ˆà¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸›à¸±à¸à¸«à¸¡à¸¸à¸”',
        inputPlaceholder: 'à¹€à¸Šà¹ˆà¸™ à¸šà¹‰à¸²à¸™à¸‚à¸­à¸‡à¸‰à¸±à¸™, à¸—à¸µà¹ˆà¸—à¸³à¸‡à¸²à¸™, à¸£à¹‰à¸²à¸™à¸à¸²à¹à¸Ÿà¹‚à¸›à¸£à¸”',
        showCancelButton: true,
        confirmButtonText: 'à¹à¸Šà¸£à¹Œà¹€à¸¥à¸¢!',
        cancelButtonText: 'à¸¢à¸à¹€à¸¥à¸´à¸',
        inputValidator: (value) => {
            if (!value) {
                return 'à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ!'
            }
        }
    });

    if (placeName) {
        shareAndSave(placeName);
    }
  }

Â  // 6) Share Flex message
async function shareTarget() {
Â  if (!meProfile) await initializeLiff();
Â  if (!myCoords) return Swal.fire('Error','à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“','warning');
Â  const [lat, lng] = myCoords;

Â  const flexMessage = {
Â  Â  type: 'flex',
Â  Â  altText: 'à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡à¸‰à¸±à¸™',
Â  Â  contents: {
Â  Â  Â  type: 'bubble',
Â  Â  Â  hero: {
Â  Â  Â  Â  type: 'image',
Â  Â  Â  Â  url: meProfile.pictureUrl,
Â  Â  Â  Â  size: 'full',
Â  Â  Â  Â  aspectRatio: '1:1',
Â  Â  Â  Â  aspectMode: 'cover'
Â  Â  Â  },
Â  Â  Â  body: {
Â  Â  Â  Â  type: 'box',
Â  Â  Â  Â  layout: 'vertical',
Â  Â  Â  Â  contents: [
Â  Â  Â  Â  Â  { type: 'text', text:`${meProfile.displayName} à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆà¸™à¸µà¹ˆ`, weight:'bold', size:'md', margin:'md' },
Â  Â  Â  Â  Â  { type: 'text', text:`Latitude: ${lat.toFixed(6)}\nLongitude: ${lng.toFixed(6)}`, wrap:true, margin:'sm' }
Â  Â  Â  Â  ]
Â  Â  Â  },
Â  Â  Â  footer: {
Â  Â  Â  Â  type: 'box',
Â  Â  Â  Â  layout: 'vertical',
Â  Â  Â  Â  spacing: 'sm',
Â  Â  Â  Â  contents: [
Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  type:'button',
Â  Â  Â  Â  Â  Â  style:'primary',
Â  Â  Â  Â  Â  Â  action:{
Â  Â  Â  Â  Â  Â  Â  type:'uri',
Â  Â  Â  Â  Â  Â  Â  label:'à¸™à¸³à¸—à¸²à¸‡à¹„à¸›à¸¢à¸±à¸‡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸™à¸µà¹‰',
Â  Â  Â  Â  Â  Â  Â  // <-- omit origin so Maps uses your device location automatically
Â  Â  Â  Â  Â  Â  Â  uri: `https://www.google.com/maps/dir/?api=1`
Â  Â  Â  Â  Â  Â  Â  Â  Â + `&destination=${lat},${lng}`
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  ]
Â  Â  Â  }
Â  Â  }
Â  };

Â  if (liff.isInClient() && liff.isApiAvailable('shareTargetPicker')) {
Â  Â  try { await liff.shareTargetPicker([flexMessage]); return; }
Â  Â  catch (e) { console.warn(e); }
Â  }

Â  // fallback
Â  window.open(
Â  Â  `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(
Â  Â  Â  Â `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`
Â  Â  )}`,
Â  Â  '_blank'
Â  );
}


Â  // 7) DOM Ready
Â  $(async () => {
Â  Â  await initializeLiff();
Â  Â  initMap();
    // <!-- UPDATED 9: Changed the click event to call our new prompt function -->
Â  Â  $('#btn-share').click(promptForPlaceName);
Â  Â  $('#btn-picker').click(shareTarget);
Â  Â  $('#btn-refresh').click(initializeLiff);
Â  });
</script>
Â  Â Â 
Â  Â  <div class="w-full mt-4">
<!-- Footer -->
<footer class="bg-white border-t border-gray-200 py-4">
<div class="container mx-auto px-4 text-center text-sm">
<p>Â© <script>document.write(new Date().getFullYear());</script> Copyright | à¸à¸±à¸’à¸™à¸²à¹‚à¸”à¸¢à¸„à¸£à¸¹à¸ªà¸´à¸—à¸˜à¸´à¸Šà¸²à¸•à¸´ à¸ªà¸´à¸—à¸˜à¸´
<a href="https://www.facebook.com/SanwithzWebapp" target="_blank"><i class="fa-brands fa-facebookÂ  text-blue-500 hover:text-blue-700"></i></a>
<a href="https://www.youtube.com/@Sanwithz" target="_blank"><i class="fa-brands fa-youtube text-red-500 hover:text-red-700"></i></a></p>
</div>
</footer>
</div>
Â  Â Â 
</body>
</html>
